/**
 *
 * Minesweep.js
 * 
 * programmed by muffinshades
 * Copyright muffinshades 2023 All Rights Reserved
 * Minified with the google closure compiler
 */

(function(){'use strict';const f=document.getElementById("c"),g=f.getContext("2d"),h=document.getElementById("face_canvas"),k=h.getContext("2d"),l=document.getElementById("timer-canvas"),n=l.getContext("2d");let q=10,r=10,t=10;f.width=32*q;f.height=32*r;h.width=46;h.height=46;l.height=46;l.width=46;let u=0,v=0,w=0;function x(){let a=document.documentElement;w=a.clientHeight/2-f.height/2;v=a.clientWidth/2-f.width/2;f.style.top=w+"px";f.style.left=v+"px";h.style.top=w-46-7+"px";h.style.left=a.clientWidth/2-23+"px";l.style.top=w-46-7+"px";l.style.left=v+"px";75>a.clientWidth/2-23-v&&(l.style.left=a.clientWidth/2-23-75+"px")}let y=[],z=[],A=0;for(let a=0;a<r;a++){y[a]=[];z[a]=[];for(let b=0;b<q;b++)y[a][b]=0,z[a][b]=1}let B=new Image;B.src="spritesheet.png";var C=!1;let D=!1;function E(a){for(let b=0;b<a;b++){let c=Math.floor(Math.random()*q),d=Math.floor(Math.random()*r);for(;10==y[d][c];)c=Math.floor(Math.random()*q),d=Math.floor(Math.random()*r);y[d][c]=10}}function F(){n.clearRect(0,0,l.width,l.height);let a=A.toString();l.width=Math.max(15+25*a.length,65);l.height=37;1==a.length&&(a="0"+a);n.fillStyle="#c3c3c3";n.fillRect(0,0,l.width,l.height);let b=0;for(let c=0;c<a.length;c++)n.drawImage(B,32*parseInt(a[c]),0,32,32,b+5,5,32,32),b+=25}function G(){for(let a=0;a<r;a++)for(let b=0;b<q;b++){if(10==y[a][b])continue;let c=0;for(let d=-1;1>=d;d++)for(let e=-1;1>=e;e++)0>a+d||a+d>=r||0>b+e||b+e>=q||10==y[a+d][b+e]&&c++;y[a][b]=c}}function H(){g.clearRect(0,0,f.width,f.height);for(let a=0;a<r;a++)for(let b=0;b<q;b++)g.drawImage(B,32*z[a][b],32,32,32,32*b,32*a,32,32),0==z[a][b]&&0<y[a][b]&&g.drawImage(B,32*y[a][b],0,32,32,32*b,32*a,32,32)}function I(){k.clearRect(0,0,64,64);k.drawImage(B,46*u,64,46,46,0,0,h.width,h.height)}function J(){q=parseInt(document.getElementById("board_width").value)||0;r=parseInt(document.getElementById("board_height").value)||0;t=Math.min(parseInt(document.getElementById("n_mines").value),q*r-1)||0;f.width=32*q;f.height=32*r;x();for(let a=0;a<r;a++){y[a]=[];z[a]=[];for(let b=0;b<q;b++)y[a][b]=0,z[a][b]=1}E(t);G();H();I();A=0;F();K=0;D=!0;C=!1}B.onload=function(){J()};let K=0;function L(a,b){if(10!=y[b][a]){var c=0;for(var d=-1;1>=d;d++)for(var e=-1;1>=e;e++)0>b+d||b+d>=r||0>a+e||a+e>=q||2==z[b+d][a+e]&&c++;d=!1;var p=e=0;if(c==y[b][a]){for(c=-1;1>=c;c++)for(let m=-1;1>=m;m++)0>b+c||b+c>=r||0>a+m||a+m>=q||1!=z[b+c][a+m]||(z[b+c][a+m]=0,10==y[b+c][a+m]&&(d=!0),e=a+m,p=b+c);H()}d&&M(e,p)}}function M(a,b){C=D=!1;g.clearRect(0,0,f.width,f.height);for(let c=0;c<r;c++)for(let d=0;d<q;d++)c==b&&d==a?(g.fillStyle="#f00",g.fillRect(32*d,32*c,32,32)):(z[c][d]=2==z[c][d]&&10!=y[c][d]?3:0,g.drawImage(B,32*z[c][d],32,32,32,32*d,32*c,32,32)),0==z[c][d]&&0<y[c][d]&&g.drawImage(B,32*y[c][d],0,32,32,32*d,32*c,32,32);u=2;I()}let N=!1,O=-1,P=-1;f.addEventListener("mousedown",function(a){if(D){var b=a.pageX-v,c=a.pageY-w;if(0<=b&&b<=f.width&&0<=c&&c<=f.height){b=Math.floor(b/32);c=Math.floor(c/32);if(0==a.button){0==K&&(C=!0);if(N&&O==b&&P==c&&0==z[c][b]){L(b,c);return}N=!0;O=b;P=c;if(2!=z[c][b]){for(;10==y[c][b]&&0==K;)y[c][b]=0,E(1);G();a=[];for(a.push({x:b,y:c});0<a.length;){var d=a.pop(),e=d.y;d=d.x;z[e][d]=0;for(let p=-1;1>=p;p++)for(let m=-1;1>=m;m++)0>e+p||e+p>=r||0>d+m||d+m>=q||0<y[e+p][d+m]&&0<y[e][d]||1!=z[e+p][d+m]||a.push({x:d+m,y:e+p})}if(10==y[c][b]){M(b,c);return}}else z[c][b]=1;K++}else if(2==a.button){if(N&&O==b&&P==c&&0==z[c][b]){L(b,c);return}N=!0;O=b;P=c;2!=z[c][b]&&0!=z[c][b]?z[c][b]=2:2==z[c][b]&&(z[c][b]=1)}H()}c=b=0;for(a=0;a<r;a++)for(e=0;e<q;e++)0<z[a][e]&&b++,10==y[a][e]&&0<z[a][e]&&c++;c==b&&c==t&&(D=C=!1,u=3,b=parseInt(document.getElementById("top_score").innerText)||0,A<b&&(document.getElementById("top_score").innerText=A.toString()),I(),H())}});f.addEventListener("mouseup",function(){N=!1});window.addEventListener("contextmenu",function(a){a.preventDefault();return!1});h.addEventListener("mousedown",function(){u=1;I()});h.addEventListener("mouseup",function(){1==u&&J();u=0;I()});setInterval(function(){C&&(A++,F())},1E3);x();I()})();